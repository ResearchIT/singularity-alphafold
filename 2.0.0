Bootstrap: docker
From: nvidia/cuda:11.1-base

%environment
export PATH=$PATH:/opt/hhsuite/bin:/opt/conda/bin:/usr/local/cuda/bin
export LD_LIBRARY_PATH=/usr/local/cuda/lib64

%post -c /bin/bash
export CUDA_VERSION=11.1
export DEBIAN_FRONTEND=noninteractive DEBCONF_NONINTERACTIVE_SEEN=true
export OS=ubuntu2004
apt-get update -y
apt-get install -y curl software-properties-common
curl -L https://developer.download.nvidia.com/compute/cuda/repos/${OS}/x86_64/cuda-${OS}.pin -o /etc/apt/preferences.d/cuda-repository-pin-600
apt-key adv --fetch-keys https://developer.download.nvidia.com/compute/cuda/repos/${OS}/x86_64/7fa2af80.pub
add-apt-repository "deb https://developer.download.nvidia.com/compute/cuda/repos/${OS}/x86_64/ /"
apt-get update -y
apt-get install -y build-essential cmake libcudnn8 libcusolver-${CUDA_VERSION/./-} cuda-command-line-tools-${CUDA_VERSION/./-} git hmmer kalign tzdata
rm -rf /var/lib/apt/lists/*

mkdir /build

#build hhsuite
cd /build
git clone --branch v3.3.0 https://github.com/soedinglab/hh-suite.git
mkdir hh-suite/build
cd hh-suite/build
cmake -DCMAKE_INSTALL_PREFIX=/opt/hhsuite ..
make -j16
make install
for i in $(ls /opt/hhsuite/bin); do ln -s /opt/hhsuite/bin/$i /usr/bin/$i; done;
cd /build

#conda
curl -L https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-x86_64.sh -o miniconda-install.sh
bash miniconda-install.sh -b -p /opt/conda
export PATH=$PATH:/opt/conda/bin
conda update -qy conda
conda install -y -c conda-forge openmm=7.5.1 cudatoolkit==${CUDA_VERSION}.1 pdbfixer pip

#alphafold proper
mkdir /app
git clone https://github.com/deepmind/alphafold.git /app/alphafold
curl -L https://git.scicore.unibas.ch/schwede/openstructure/-/raw/7102c63615b64735c4941278d92b554ec94415f8/modules/mol/alg/src/stereo_chemical_props.txt -o /app/alphafold/alphafold/common/stereo_chemical_props.txt

pip3 install --upgrade pip
pip3 install -r /app/alphafold/requirements.txt
pip3 install --upgrade jax jaxlib==0.1.69+cuda${CUDA_VERSION/./} -f https://storage.googleapis.com/jax-releases/jax_releases.html

#patch openMM
cd /opt/conda/lib/python3.9/site-packages
patch -p0 < /app/alphafold/docker/openmm.patch

ldconfig
rm -rf /build
